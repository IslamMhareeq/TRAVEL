@{
    ViewData["Title"] = "My Bookings";
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Bookings - TRAVIL</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        :root {
            --color-midnight: #0d1117;
            --color-navy: #161b22;
            --color-slate: #21262d;
            --color-charcoal: #30363d;
            --color-steel: #484f58;
            --color-silver: #8b949e;
            --color-mist: #c9d1d9;
            --color-white: #ffffff;
            --color-gold: #d4a853;
            --color-gold-dark: #b8943f;
            --color-gold-muted: rgba(212, 168, 83, 0.15);
            --color-success: #3fb950;
            --color-success-muted: rgba(63, 185, 80, 0.15);
            --color-warning: #d29922;
            --color-warning-muted: rgba(210, 153, 34, 0.15);
            --color-danger: #f85149;
            --color-danger-muted: rgba(248, 81, 73, 0.15);
            --color-info: #58a6ff;
            --color-info-muted: rgba(88, 166, 255, 0.15);
            --font-display: 'Cormorant Garamond', serif;
            --font-body: 'Outfit', sans-serif;
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 24px;
            --space-6: 32px;
            --space-7: 48px;
            --space-8: 64px;
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-full: 9999px;
            --transition-fast: 0.15s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--color-midnight);
            color: var(--color-white);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Layout */
        .dashboard-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--color-navy);
            border-right: 1px solid var(--color-slate);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: var(--space-5);
            border-bottom: 1px solid var(--color-slate);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            text-decoration: none;
            color: var(--color-gold);
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .sidebar-nav {
            padding: var(--space-4);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            color: var(--color-silver);
            text-decoration: none;
            border-radius: var(--radius-md);
            margin-bottom: var(--space-2);
            transition: all var(--transition-fast);
        }

            .nav-item:hover, .nav-item.active {
                background: var(--color-slate);
                color: var(--color-white);
            }

            .nav-item.active {
                border-left: 3px solid var(--color-gold);
            }

            .nav-item i {
                width: 20px;
            }

        .sidebar-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: var(--space-4);
            border-top: 1px solid var(--color-slate);
            background: var(--color-navy);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: linear-gradient(135deg, var(--color-gold), var(--color-gold-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--color-midnight);
        }

        .user-name {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .user-email {
            font-size: 0.75rem;
            color: var(--color-silver);
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: var(--space-6);
        }

        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
            gap: var(--space-4);
        }

        .page-title {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 500;
        }

        .page-subtitle {
            color: var(--color-silver);
            font-size: 0.9rem;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--color-white);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--color-slate);
            border: 1px solid var(--color-charcoal);
            border-radius: var(--radius-full);
            color: var(--color-silver);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

            .filter-btn:hover, .filter-btn.active {
                background: var(--color-gold);
                border-color: var(--color-gold);
                color: var(--color-midnight);
            }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .stat-item {
            background: var(--color-navy);
            border: 1px solid var(--color-slate);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-gold);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--color-silver);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Bookings Grid */
        .bookings-grid {
            display: grid;
            gap: var(--space-5);
        }

        /* Booking Card */
        .booking-card {
            background: var(--color-navy);
            border: 1px solid var(--color-slate);
            border-radius: var(--radius-lg);
            overflow: hidden;
            display: grid;
            grid-template-columns: 280px 1fr;
            transition: all var(--transition-fast);
        }

            .booking-card:hover {
                border-color: var(--color-gold);
                transform: translateY(-2px);
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            }

        .booking-image-container {
            position: relative;
            height: 100%;
            min-height: 200px;
        }

        .booking-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .booking-badge {
            position: absolute;
            top: var(--space-3);
            left: var(--space-3);
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

            .status-badge.confirmed {
                background: var(--color-success-muted);
                color: var(--color-success);
            }

            .status-badge.pending {
                background: var(--color-warning-muted);
                color: var(--color-warning);
            }

            .status-badge.cancelled {
                background: var(--color-danger-muted);
                color: var(--color-danger);
            }

            .status-badge.completed {
                background: var(--color-info-muted);
                color: var(--color-info);
            }

        /* Countdown Badge */
        .countdown-badge {
            position: absolute;
            bottom: var(--space-3);
            left: var(--space-3);
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
        }

        .countdown-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-gold);
        }

        .countdown-label {
            font-size: 0.7rem;
            color: var(--color-silver);
            text-transform: uppercase;
        }

        .booking-content {
            padding: var(--space-5);
            display: flex;
            flex-direction: column;
        }

        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-3);
        }

        .booking-destination {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 500;
        }

        .booking-country {
            color: var(--color-gold);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .booking-ref {
            font-size: 0.8rem;
            color: var(--color-silver);
            background: var(--color-slate);
            padding: 4px 10px;
            border-radius: var(--radius-sm);
        }

        .booking-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4);
            margin: var(--space-4) 0;
            padding: var(--space-4) 0;
            border-top: 1px solid var(--color-slate);
            border-bottom: 1px solid var(--color-slate);
        }

        .detail-item {
        }

        .detail-label {
            font-size: 0.75rem;
            color: var(--color-silver);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .detail-value {
            font-weight: 500;
        }

        .booking-actions {
            display: flex;
            gap: var(--space-3);
            margin-top: auto;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-gold), var(--color-gold-dark));
            color: var(--color-midnight);
        }

            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(212, 168, 83, 0.3);
            }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--color-slate);
            color: var(--color-mist);
        }

            .btn-outline:hover {
                border-color: var(--color-gold);
                color: var(--color-gold);
            }

        .btn-success {
            background: var(--color-success);
            color: var(--color-white);
        }

        .btn-danger {
            background: var(--color-danger);
            color: var(--color-white);
        }

        .btn-sm {
            padding: var(--space-2) var(--space-3);
            font-size: 0.8rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-8);
        }

            .empty-state i {
                font-size: 4rem;
                color: var(--color-steel);
                margin-bottom: var(--space-4);
            }

            .empty-state h3 {
                font-family: var(--font-display);
                font-size: 1.5rem;
                margin-bottom: var(--space-3);
            }

            .empty-state p {
                color: var(--color-silver);
                margin-bottom: var(--space-5);
            }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--space-8);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-slate);
            border-top-color: var(--color-gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--color-charcoal);
            color: var(--color-white);
            padding: var(--space-4) var(--space-5);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

            .toast.show {
                transform: translateY(0);
                opacity: 1;
            }

            .toast.success {
                border-left: 4px solid var(--color-success);
            }

            .toast.error {
                border-left: 4px solid var(--color-danger);
            }

        @@keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @@media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

                .sidebar.active {
                    transform: translateX(0);
                }

            .sidebar-overlay.active {
                display: block;
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @@media (max-width: 768px) {
            .booking-card {
                grid-template-columns: 1fr;
            }

            .booking-image-container {
                height: 200px;
            }

            .booking-details {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-bar {
                grid-template-columns: 1fr 1fr;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/" class="sidebar-logo" onclick="navigateTo('/', event)">
                    <i class="fas fa-paper-plane"></i> TRAVIL
                </a>
            </div>
            <nav class="sidebar-nav">
                <a href="/account/dashboard" class="nav-item" onclick="navigateTo('/account/dashboard', event)">
                    <i class="fas fa-th-large"></i><span>Dashboard</span>
                </a>
                <a href="/account/bookings" class="nav-item active">
                    <i class="fas fa-calendar-check"></i><span>My Bookings</span>
                </a>
                <a href="/account/wishlist" class="nav-item" onclick="navigateTo('/account/wishlist', event)">
                    <i class="fas fa-heart"></i><span>Wishlist</span>
                </a>
                <a href="/packages" class="nav-item" onclick="navigateTo('/packages', event)">
                    <i class="fas fa-suitcase"></i><span>Browse Packages</span>
                </a>
                <a href="/cart" class="nav-item" onclick="navigateTo('/cart', event)">
                    <i class="fas fa-shopping-cart"></i><span>Cart</span>
                </a>
                <a href="/account/profile" class="nav-item" onclick="navigateTo('/account/profile', event)">
                    <i class="fas fa-user"></i><span>Profile</span>
                </a>
                <a href="#" class="nav-item" onclick="logout(event)">
                    <i class="fas fa-sign-out-alt"></i><span>Logout</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div class="user-name" id="userName">User</div>
                        <div class="user-email" id="userEmail">user@example.com</div>
                    </div>
                </div>
            </div>
        </aside>

        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div>
                    <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i></button>
                    <h1 class="page-title">My Bookings</h1>
                    <p class="page-subtitle">Manage your travel reservations</p>
                </div>
                <div class="filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="upcoming">Upcoming</button>
                    <button class="filter-btn" data-filter="confirmed">Confirmed</button>
                    <button class="filter-btn" data-filter="pending">Pending</button>
                    <button class="filter-btn" data-filter="past">Past Trips</button>
                </div>
            </div>

            <!-- Stats Bar -->
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-value" id="totalBookings">0</div>
                    <div class="stat-label">Total Bookings</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="upcomingCount">0</div>
                    <div class="stat-label">Upcoming</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="confirmedCount">0</div>
                    <div class="stat-label">Confirmed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="pastCount">0</div>
                    <div class="stat-label">Completed</div>
                </div>
            </div>

            <!-- Bookings Grid -->
            <div class="bookings-grid" id="bookingsGrid">
                <div class="loading" id="loader"><div class="spinner"></div></div>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <i class="fas fa-suitcase-rolling"></i>
                <h3>No Bookings Found</h3>
                <p>Start exploring amazing destinations and book your dream vacation!</p>
                <a href="/packages" class="btn btn-primary" onclick="navigateTo('/packages', event)">
                    <i class="fas fa-compass"></i> Explore Packages
                </a>
            </div>
        </main>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Message</span>
    </div>

    <script>
        var allBookings = [];
        var currentFilter = 'all';

        // Navigation
        function navigateTo(url, event) {
            if (event) event.preventDefault();
            window.location.href = url;
        }

        function logout(event) {
            if (event) event.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            navigateTo('/account/login');
        }

        // Toast
        function showToast(message, type) {
            var toast = document.getElementById('toast');
            var toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = 'toast ' + (type || 'success') + ' show';
            setTimeout(function() { toast.classList.remove('show'); }, 3000);
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            var date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Calculate days until trip
        function getDaysUntil(dateString) {
            if (!dateString) return 0;
            var tripDate = new Date(dateString);
            var today = new Date();
            var diff = tripDate - today;
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }

        // Get status info
        function getStatusInfo(status, daysUntil) {
            var statusLower = (status || '').toLowerCase();
            if (statusLower === 'confirmed') return { class: 'confirmed', icon: 'fa-check', text: 'Confirmed' };
            if (statusLower === 'pending') return { class: 'pending', icon: 'fa-hourglass-half', text: 'Pending' };
            if (statusLower === 'cancelled') return { class: 'cancelled', icon: 'fa-times', text: 'Cancelled' };
            if (statusLower === 'completed' || daysUntil < 0) return { class: 'completed', icon: 'fa-flag-checkered', text: 'Completed' };
            return { class: 'pending', icon: 'fa-clock', text: status };
        }

        // Render bookings
        function renderBookings(bookings) {
            var grid = document.getElementById('bookingsGrid');
            var emptyState = document.getElementById('emptyState');
            var loader = document.getElementById('loader');

            loader.style.display = 'none';

            if (!bookings || bookings.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            var html = bookings.map(function(booking) {
                var daysUntil = getDaysUntil(booking.startDate);
                var statusInfo = getStatusInfo(booking.status, daysUntil);
                var isUpcoming = daysUntil > 0 && booking.status !== 'Cancelled';
                var isPast = daysUntil <= 0;
                var canCancel = isUpcoming && daysUntil >= 3 && booking.status !== 'Cancelled';
                var canDownload = booking.status === 'Confirmed' || booking.status === 'Completed';

                var imageUrl = booking.imageUrl || 'https://images.unsplash.com/photo-1506929562872-bb421503ef21?w=400&q=80';

                var cardHtml = '<div class="booking-card" data-status="' + booking.status + '" data-days="' + daysUntil + '">';

                // Image container with countdown
                cardHtml += '<div class="booking-image-container">';
                cardHtml += '<img src="' + imageUrl + '" alt="' + (booking.destination || 'Destination') + '" class="booking-image" onerror="this.src=\'https://images.unsplash.com/photo-1506929562872-bb421503ef21?w=400&q=80\'">';
                cardHtml += '<div class="booking-badge"><span class="status-badge ' + statusInfo.class + '"><i class="fas ' + statusInfo.icon + '"></i> ' + statusInfo.text + '</span></div>';

                // Countdown badge for upcoming trips
                if (isUpcoming && !isPast) {
                    cardHtml += '<div class="countdown-badge">';
                    if (daysUntil === 0) {
                        cardHtml += '<div class="countdown-value">Today!</div>';
                        cardHtml += '<div class="countdown-label">Departure</div>';
                    } else if (daysUntil === 1) {
                        cardHtml += '<div class="countdown-value">Tomorrow!</div>';
                        cardHtml += '<div class="countdown-label">Departure</div>';
                    } else {
                        cardHtml += '<div class="countdown-value">' + daysUntil + '</div>';
                        cardHtml += '<div class="countdown-label">Days to Go</div>';
                    }
                    cardHtml += '</div>';
                }

                cardHtml += '</div>';

                // Content
                cardHtml += '<div class="booking-content">';
                cardHtml += '<div class="booking-header">';
                cardHtml += '<div>';
                cardHtml += '<h3 class="booking-destination">' + (booking.destination || 'Unknown') + '</h3>';
                cardHtml += '<div class="booking-country"><i class="fas fa-map-marker-alt"></i> ' + (booking.country || 'Unknown') + '</div>';
                cardHtml += '</div>';
                cardHtml += '<span class="booking-ref">' + (booking.bookingReference || 'N/A') + '</span>';
                cardHtml += '</div>';

                // Details
                cardHtml += '<div class="booking-details">';
                cardHtml += '<div class="detail-item"><div class="detail-label">Travel Dates</div><div class="detail-value">' + formatDate(booking.startDate) + ' - ' + formatDate(booking.endDate) + '</div></div>';
                cardHtml += '<div class="detail-item"><div class="detail-label">Guests</div><div class="detail-value">' + (booking.numberOfGuests || 1) + ' Guest(s), ' + (booking.numberOfRooms || 1) + ' Room(s)</div></div>';
                cardHtml += '<div class="detail-item"><div class="detail-label">Total Price</div><div class="detail-value" style="color: var(--color-gold); font-weight: 600;">$' + (booking.totalPrice || 0).toLocaleString() + '</div></div>';
                cardHtml += '</div>';

                // Actions
                cardHtml += '<div class="booking-actions">';
                cardHtml += '<a href="/booking/details/' + booking.bookingId + '" class="btn btn-outline btn-sm"><i class="fas fa-eye"></i> View Details</a>';

                // Download itinerary button (only for confirmed/completed)
                if (canDownload) {
                    cardHtml += '<button class="btn btn-primary btn-sm" onclick="downloadItinerary(' + booking.bookingId + ')"><i class="fas fa-file-pdf"></i> Download Itinerary</button>';
                }

                // Cancel button (only if cancellation allowed)
                if (canCancel && booking.status !== 'Confirmed') {
                    cardHtml += '<button class="btn btn-danger btn-sm" onclick="cancelBooking(' + booking.bookingId + ')"><i class="fas fa-times"></i> Cancel</button>';
                }

                // Review button (for completed trips)
                if (isPast && (booking.status === 'Confirmed' || booking.status === 'Completed')) {
                    var pkgId = booking.packageId || booking.travelPackage?.packageId || '';
                    if (pkgId) {
                        cardHtml += '<a href="/packages/' + pkgId + '#reviews" class="btn btn-outline btn-sm"><i class="fas fa-star"></i> Write Review</a>';
                    }
                }

                cardHtml += '</div>';
                cardHtml += '</div>';
                cardHtml += '</div>';

                return cardHtml;
            }).join('');

            grid.innerHTML = html;
        }

        // Filter bookings
        function filterBookings(filter) {
            currentFilter = filter;
            var now = new Date();

            var filtered = allBookings.filter(function(b) {
                var startDate = new Date(b.startDate);
                var daysUntil = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));
                var isUpcoming = daysUntil > 0;
                var isPast = daysUntil <= 0;

                if (filter === 'all') return true;
                if (filter === 'upcoming') return isUpcoming && b.status !== 'Cancelled';
                if (filter === 'confirmed') return b.status === 'Confirmed';
                if (filter === 'pending') return b.status === 'Pending';
                if (filter === 'past') return isPast || b.status === 'Completed';
                return true;
            });

            renderBookings(filtered);
        }

        // Update stats
        function updateStats(bookings) {
            var now = new Date();
            var total = bookings.length;
            var upcoming = 0;
            var confirmed = 0;
            var past = 0;

            bookings.forEach(function(b) {
                var startDate = new Date(b.startDate);
                var daysUntil = Math.ceil((startDate - now) / (1000 * 60 * 60 * 24));

                if (b.status === 'Confirmed') confirmed++;
                if (daysUntil > 0 && b.status !== 'Cancelled') upcoming++;
                if (daysUntil <= 0 || b.status === 'Completed') past++;
            });

            document.getElementById('totalBookings').textContent = total;
            document.getElementById('upcomingCount').textContent = upcoming;
            document.getElementById('confirmedCount').textContent = confirmed;
            document.getElementById('pastCount').textContent = past;
        }

        // Load bookings
        async function loadBookings() {
            var token = localStorage.getItem('token');
            if (!token) {
                navigateTo('/account/login');
                return;
            }

            try {
                var response = await fetch('/api/booking/my-bookings', {
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });

                document.getElementById('loader').style.display = 'none';

                if (response.ok) {
                    var result = await response.json();
                    allBookings = result.data || [];

                    // Sort by start date (upcoming first)
                    allBookings.sort(function(a, b) {
                        return new Date(a.startDate) - new Date(b.startDate);
                    });

                    updateStats(allBookings);
                    renderBookings(allBookings);
                } else {
                    document.getElementById('emptyState').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading bookings:', error);
                document.getElementById('loader').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        // Download itinerary PDF
        async function downloadItinerary(bookingId) {
            var token = localStorage.getItem('token');

            showToast('Generating PDF...', 'success');

            try {
                var response = await fetch('/api/itinerary/download/' + bookingId, {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok) {
                    var blob = await response.blob();
                    var url = window.URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = 'TRAVIL_Itinerary_' + bookingId + '.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    showToast('Itinerary downloaded successfully!', 'success');
                } else {
                    var error = await response.json();
                    showToast(error.message || 'Failed to download itinerary', 'error');
                }
            } catch (error) {
                console.error('Error downloading itinerary:', error);
                showToast('Error downloading itinerary', 'error');
            }
        }

        // Cancel booking
        async function cancelBooking(bookingId) {
            if (!confirm('Are you sure you want to cancel this booking? This action cannot be undone.')) return;

            var token = localStorage.getItem('token');

            try {
                var response = await fetch('/api/booking/' + bookingId + '/cancel', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: 'Cancelled by user' })
                });

                if (response.ok) {
                    showToast('Booking cancelled successfully', 'success');
                    loadBookings();
                } else {
                    var error = await response.json();
                    showToast(error.message || 'Failed to cancel booking', 'error');
                }
            } catch (error) {
                console.error('Error cancelling booking:', error);
                showToast('Error cancelling booking', 'error');
            }
        }

        // Mobile menu
        document.getElementById('mobileMenuBtn').addEventListener('click', function() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebarOverlay').classList.toggle('active');
        });

        document.getElementById('sidebarOverlay').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('active');
            this.classList.remove('active');
        });

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
                this.classList.add('active');
                filterBookings(this.dataset.filter);
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            var token = localStorage.getItem('token');
            var user = localStorage.getItem('user');

            if (!token || !user) {
                navigateTo('/account/login');
                return;
            }

            try {
                var userData = JSON.parse(user);
                document.getElementById('userName').textContent = (userData.firstName || '') + ' ' + (userData.lastName || '');
                document.getElementById('userEmail').textContent = userData.email || '';
                document.getElementById('userAvatar').textContent = (userData.firstName || 'U').charAt(0).toUpperCase();
            } catch (e) {}

            loadBookings();
        });
    </script>
</body>
</html>
